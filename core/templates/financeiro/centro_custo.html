{% extends 'base.html' %}

{% block title %}Centro de Custo{% endblock %}

{% block content %}
<div class="container mt-4">
    <h3 class="mb-4">Centro de Custo</h3>
    
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}
    
    <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#adicionarCentroCustoModal">
        <i class="bi bi-plus-circle"></i> Adicionar Item
    </button>
    
    {% if form.errors %}
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const modal = new bootstrap.Modal(document.getElementById('adicionarCentroCustoModal'));
                modal.show();
            });
        </script>
    {% endif %}

    <table class="table table-bordered table-striped" id="datatable">
        <thead class="table-dark">
            <tr>
                <th>Código</th>
                <th>Descrição</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tfoot>
            <tr>
                <th><input type="text" placeholder="Filtrar Código" class="form-control form-control-sm" /></th>
                <th><input type="text" placeholder="Filtrar Descrição" class="form-control form-control-sm" /></th>
                <th></th>
            </tr>
        </tfoot>
        <tbody>
            {% for centro_custo in centros_custo %}
                <tr>
                    <td>{{ centro_custo.codigo }}</td>
                    <td>{{ centro_custo.descricao }}</td>
                    <td>
                        <div class="dropdown">
                            <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton{{ centro_custo.codigo }}" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Ações
                            </button>
                            <div class="dropdown-menu" aria-labelledby="dropdownMenuButton{{ centro_custo.codigo }}">
                                <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#editarCentroCustoModal" data-centro-custo-id="{{ centro_custo.codigo }}" data-centro-custo-descricao="{{ centro_custo.descricao }}"><i class="bi bi-pencil"></i> Editar</a>
                            </div>
                        </div>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Modal para Adicionar Centro de Custo -->
<div class="modal fade" id="adicionarCentroCustoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" id="form-adicionar-centro-custo">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title">Adicionar Centro de Custo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    {% if form.errors %}
                        <div class="alert alert-danger">
                            <strong>Por favor, corrija os erros abaixo:</strong>
                            <ul class="mb-0">
                                {% for field, errors in form.errors.items %}
                                    {% for error in errors %}
                                        <li>{{ field }}: {{ error }}</li>
                                    {% endfor %}
                                {% endfor %}
                            </ul>
                        </div>
                    {% endif %}
                    <div class="mb-3">
                        <label for="{{ form.descricao.id_for_label }}" class="form-label">
                            {{ form.descricao.label }} <span class="text-danger">*</span>
                        </label>
                        {{ form.descricao }}
                        {% if form.descricao.help_text %}
                            <small class="form-text text-muted">{{ form.descricao.help_text }}</small>
                        {% endif %}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para Editar Centro de Custo -->
<div class="modal fade" id="editarCentroCustoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" id="form-editar-centro-custo">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-pencil"></i> Editar Centro de Custo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="editar_centro_custo_id" id="editar_centro_custo_id">
                    
                    <div class="mb-3">
                        <label for="editar_descricao" class="form-label">
                            Descrição <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" id="editar_descricao" name="descricao" maxlength="20" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle"></i> Salvar Alterações
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Configurar modal de edição quando abrir
document.addEventListener('DOMContentLoaded', function() {
    const editarModal = document.getElementById('editarCentroCustoModal');
    if (editarModal) {
        editarModal.addEventListener('show.bs.modal', function(event) {
            // Botão que acionou o modal
            const button = event.relatedTarget;
            
            // Extrai dados dos atributos data-*
            const centroCustoId = button.getAttribute('data-centro-custo-id');
            const centroCustoDescricao = button.getAttribute('data-centro-custo-descricao');
            
            // Preenche os campos do modal
            document.getElementById('editar_centro_custo_id').value = centroCustoId;
            document.getElementById('editar_descricao').value = centroCustoDescricao;
        });
        
        // Limpar formulário quando o modal for fechado
        editarModal.addEventListener('hidden.bs.modal', function() {
            document.getElementById('form-editar-centro-custo').reset();
        });
    }
});

// Limpar formulário quando o modal de adicionar for fechado
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('adicionarCentroCustoModal');
    if (modal) {
        modal.addEventListener('hidden.bs.modal', function() {
            document.getElementById('form-adicionar-centro-custo').reset();
            // Limpar erros do formulário
            const errorAlert = modal.querySelector('.alert-danger');
            if (errorAlert) {
                errorAlert.remove();
            }
        });
    }
});

// Inicializar DataTables com filtros por coluna
$(document).ready(function() {
    setTimeout(function() {
        if ($.fn.DataTable.isDataTable('#datatable')) {
            $('#datatable').DataTable().destroy();
        }
        
        var table = $('#datatable').DataTable({
            language: {
                "lengthMenu": "_MENU_ Registros por página",
                "zeroRecords": "Nenhum registro encontrado",
                "info": "Total de registros: _TOTAL_",
                "infoEmpty": "Nenhum registro disponível",
                "infoFiltered": "(filtrado de _MAX_ registros)",
                "search": "Buscar:",
                "paginate": {
                    "first": "Primeira",
                    "last": "Última",
                    "next": "Próxima",
                    "previous": "Anterior"
                }
            },
            orderCellsTop: true,
            initComplete: function () {
                // Aplicar os filtros
                this.api().columns().every(function () {
                    var column = this;
                    var footer = $(column.footer());
                    
                    // Pular a última coluna (Ações)
                    if (footer.find('input').length === 0) {
                        return;
                    }
                    
                    // Aplicar filtro quando o usuário digitar
                    footer.find('input').on('keyup change', function () {
                        if (column.search() !== this.value) {
                            column.search(this.value).draw();
                        }
                    });
                });
            }
        });
    }, 100);
});
</script>
{% endblock %}

