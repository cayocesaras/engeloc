{% extends 'base.html' %}

{% block title %}Aprovação de Contas a Pagar{% endblock %}

{% block content %}
<style>
    /* Estilo para aumentar o tamanho dos checkboxes */
    #selectAll,
    .conta-checkbox {
        width: 18px;
        height: 18px;
        cursor: pointer;
        transform: scale(1.2);
        margin: 0 auto;
        display: block;
    }
    
    /* Centralizar checkboxes nas células */
    th:first-child,
    td:first-child {
        text-align: center;
        vertical-align: middle;
    }
</style>

<div class="container mt-4">
    <h3 class="mb-4">Aprovação de Contas a Pagar</h3>
    
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}
    
    <table class="table table-bordered table-striped" id="datatable">
        <thead class="table-dark">
            <tr>
                <th>
                    <input type="checkbox" id="selectAll" title="Selecionar todos">
                </th>
                <th>Fornecedor</th>
                <th>Descrição</th>
                <th>Valor Total</th>
                <th>Centro de Custo</th>
                <th>Forma de Pagamento</th>
                <th>Parcelas</th>
                <th>Emissão</th>
                <th>Vencimento</th>
                <th>Status</th>
                <th>Anexo</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tfoot>
            <tr>
                <th></th>
                <th><input type="text" placeholder="Filtrar Fornecedor" class="form-control form-control-sm" /></th>
                <th><input type="text" placeholder="Filtrar Descrição" class="form-control form-control-sm" /></th>
                <th><input type="text" placeholder="Filtrar Valor" class="form-control form-control-sm" /></th>
                <th><input type="text" placeholder="Filtrar Centro Custo" class="form-control form-control-sm" /></th>
                <th><input type="text" placeholder="Filtrar Forma Pagamento" class="form-control form-control-sm" /></th>
                <th><input type="text" placeholder="Filtrar Parcelas" class="form-control form-control-sm" /></th>
                <th><input type="text" placeholder="Filtrar Emissão" class="form-control form-control-sm" /></th>
                <th><input type="text" placeholder="Filtrar Vencimento" class="form-control form-control-sm" /></th>
                <th></th>
                <th></th>
                <th></th>
            </tr>
        </tfoot>
        <tbody>
            {% for conta in contas %}
                <tr>
                    <td>
                        <input type="checkbox" class="conta-checkbox" name="contas_selecionadas" value="{{ conta.id }}">
                    </td>
                    <td>{% if conta.fornecedor %}{{ conta.fornecedor.razao }}{% else %}-{% endif %}</td>
                    <td>{{ conta.descricao }}</td>
                    <td>R$ {{ conta.valor|floatformat:2 }}</td>
                    <td>{% if conta.centro_custo %}{{ conta.centro_custo.descricao }}{% else %}-{% endif %}</td>
                    <td>{% if conta.forma_pagamento %}{{ conta.get_forma_pagamento_display }}{% else %}-{% endif %}</td>
                    <td>Parcela {{ conta.parcela_atual }} de {{ conta.quantidade_parcelas }}</td>
                    <td>{{ conta.data_emissao|date:"d/m/Y" }}</td>
                    <td>{{ conta.data_vencimento|date:"d/m/Y" }}</td>
                    <td>
                        <span class="badge bg-info text-white">
                            {{ conta.get_status_display }}
                        </span>
                    </td>
                    <td>
                        {% if conta.anexo %}
                            <a href="{{ conta.anexo.url }}" target="_blank" class="btn btn-sm btn-primary text-white">
                                <i class="bi bi-paperclip"></i> Ver Anexo
                            </a>
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="dropdown">
                            <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton{{ conta.id }}" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                Ações
                            </button>
                            <div class="dropdown-menu" aria-labelledby="dropdownMenuButton{{ conta.id }}">
                                <a class="dropdown-item" href="#" onclick="autorizarPagamento({{ conta.id }})"><i class="bi bi-check-circle"></i> Autorizar Pagamento</a>
                                {% if conta.status != 'cancelado' %}
                                <a class="dropdown-item" href="#" onclick="cancelarConta({{ conta.id }})"><i class="bi bi-x-circle"></i> Cancelar</a>
                                {% endif %}
                                {% if conta.status != 'pago' and conta.status != 'cancelado' %}
                                <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#reagendarContaModal" data-conta-id="{{ conta.id }}" data-conta-descricao="{{ conta.descricao }}" data-conta-vencimento="{{ conta.data_vencimento|date:'Y-m-d' }}"><i class="bi bi-calendar-event"></i> Reagendar</a>
                                {% endif %}
                            </div>
                        </div>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
    
    <div class="row mt-3 mb-3">
        <div class="col-md-12">
            <button type="button" class="btn btn-success" id="btnAutorizarLote" onclick="autorizarPagamentosLote()">
                <i class="bi bi-check-circle"></i> Autorizar Pagamentos
            </button>
        </div>
    </div>
    
    <div class="row mt-3 mb-3">
        <div class="col-md-12">
            <div class="card border-info">
                <div class="card-body">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-clock-history"></i> Em Aprovação
                    </h5>
                    <p class="card-text mt-2 mb-0">
                        <span class="badge bg-info me-2">{{ qtd_em_aprovacao }}</span>
                        <strong class="text-info" style="font-size: 1.5rem;">R$ {{ total_em_aprovacao|floatformat:2 }}</strong>
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-3 mb-3">
        <div class="col-md-12">
            <button type="button" class="btn btn-primary" id="btnFiltrarHoje" onclick="filtrarVencimentoHoje()">
                <i class="bi bi-calendar-day"></i> Relatório do dia
            </button>
            <button type="button" class="btn btn-secondary ms-2" id="btnLimparFiltro" onclick="limparFiltroVencimento()" style="display: none;">
                <i class="bi bi-x-circle"></i> Limpar Filtro
            </button>
        </div>
    </div>
</div>

<!-- Modal para Reagendar Conta a Pagar -->
<div class="modal fade" id="reagendarContaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" id="form-reagendar-conta">
                {% csrf_token %}
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-calendar-event"></i> Reagendar Conta</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="reagendar_conta_id" id="reagendar_conta_id">
                    
                    <div class="alert alert-info mb-3" role="alert">
                        <strong><i class="bi bi-info-circle"></i> Conta:</strong>
                        <span id="modal-conta-descricao"></span>
                    </div>
                    
                    <div class="mb-3">
                        <label for="nova_data_vencimento" class="form-label">
                            Data de Vencimento <span class="text-danger">*</span>
                        </label>
                        <input type="date" class="form-control" id="nova_data_vencimento" name="nova_data_vencimento" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-calendar-check"></i> Confirmar Reagendamento
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Função auxiliar para obter o token CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function autorizarPagamento(contaId) {
    if (confirm('Deseja autorizar o pagamento desta conta?')) {
        // Cria um formulário dinamicamente e submete
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = window.location.pathname;
        
        // Adiciona o token CSRF
        const csrftoken = getCookie('csrftoken');
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrftoken;
        form.appendChild(csrfInput);
        
        // Adiciona o ID da conta a ser autorizada
        const contaInput = document.createElement('input');
        contaInput.type = 'hidden';
        contaInput.name = 'autorizar_pagamento_id';
        contaInput.value = contaId;
        form.appendChild(contaInput);
        
        // Adiciona o formulário ao body e submete
        document.body.appendChild(form);
        form.submit();
    }
}

function cancelarConta(contaId) {
    if (confirm('Deseja realmente cancelar esta conta?')) {
        // Cria um formulário dinamicamente e submete
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = window.location.pathname;
        
        // Adiciona o token CSRF
        const csrftoken = getCookie('csrftoken');
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrftoken;
        form.appendChild(csrfInput);
        
        // Adiciona o ID da conta a ser cancelada
        const contaInput = document.createElement('input');
        contaInput.type = 'hidden';
        contaInput.name = 'cancelar_conta_id';
        contaInput.value = contaId;
        form.appendChild(contaInput);
        
        // Adiciona o formulário ao body e submete
        document.body.appendChild(form);
        form.submit();
    }
}

// Configurar modal de reagendamento quando abrir
document.addEventListener('DOMContentLoaded', function() {
    const reagendarModal = document.getElementById('reagendarContaModal');
    if (reagendarModal) {
        reagendarModal.addEventListener('show.bs.modal', function(event) {
            // Botão que acionou o modal
            const button = event.relatedTarget;
            
            // Extrai dados dos atributos data-*
            const contaId = button.getAttribute('data-conta-id');
            const contaDescricao = button.getAttribute('data-conta-descricao');
            const dataVencimento = button.getAttribute('data-conta-vencimento');
            
            // Preenche os campos do modal
            document.getElementById('reagendar_conta_id').value = contaId;
            document.getElementById('modal-conta-descricao').textContent = contaDescricao;
            document.getElementById('nova_data_vencimento').value = dataVencimento;
        });
        
        // Limpar formulário quando o modal for fechado
        reagendarModal.addEventListener('hidden.bs.modal', function() {
            document.getElementById('form-reagendar-conta').reset();
        });
    }
});

// Função para autorizar pagamentos em lote
function autorizarPagamentosLote() {
    // Coleta todos os checkboxes selecionados
    const checkboxes = document.querySelectorAll('.conta-checkbox:checked');
    
    if (checkboxes.length === 0) {
        alert('Por favor, selecione pelo menos uma conta para autorizar.');
        return;
    }
    
    // Confirmação
    const quantidade = checkboxes.length;
    if (!confirm(`Deseja autorizar o pagamento de ${quantidade} conta(s) selecionada(s)?`)) {
        return;
    }
    
    // Cria um formulário dinamicamente e submete
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = window.location.pathname;
    
    // Adiciona o token CSRF
    const csrftoken = getCookie('csrftoken');
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = csrftoken;
    form.appendChild(csrfInput);
    
    // Adiciona cada conta selecionada
    checkboxes.forEach(function(checkbox) {
        const contaInput = document.createElement('input');
        contaInput.type = 'hidden';
        contaInput.name = 'autorizar_pagamento_ids';
        contaInput.value = checkbox.value;
        form.appendChild(contaInput);
    });
    
    // Adiciona o formulário ao body e submete
    document.body.appendChild(form);
    form.submit();
}

// Variável global para armazenar a instância do DataTable
var dataTableInstance = null;
// Variável para rastrear se o filtro de hoje está ativo
var filtroHojeAtivo = false;
// Função de filtro customizada
var funcaoFiltroHoje = null;

// Função para filtrar vencimentos de hoje
function filtrarVencimentoHoje() {
    if (!dataTableInstance) {
        alert('Tabela ainda não foi inicializada.');
        return;
    }
    
    // Se o filtro já está ativo, não fazer nada
    if (filtroHojeAtivo) {
        return;
    }
    
    // Obter data atual no formato dd/mm/yyyy
    const hoje = new Date();
    const dia = String(hoje.getDate()).padStart(2, '0');
    const mes = String(hoje.getMonth() + 1).padStart(2, '0');
    const ano = hoje.getFullYear();
    const dataFormatada = dia + '/' + mes + '/' + ano;
    
    // Criar função de filtro customizada
    funcaoFiltroHoje = function(settings, data, dataIndex) {
        // Verificar se estamos na tabela correta
        if (settings.nTable.id !== 'datatable') {
            return true;
        }
        
        // Obter o valor da coluna de vencimento (índice 8)
        const vencimento = data[8] || '';
        
        // Comparar com a data formatada de hoje
        return vencimento.trim() === dataFormatada;
    };
    
    // Abrir PDF do relatório em nova aba primeiro (antes de aplicar filtro)
    const pdfUrl = '{% url "rel_contas_vencimento_hoje" %}';
    window.open(pdfUrl, '_blank');
    
    // Adicionar a função de filtro
    $.fn.dataTable.ext.search.push(funcaoFiltroHoje);
    
    // Marcar filtro como ativo
    filtroHojeAtivo = true;
    
    // Aplicar o filtro
    dataTableInstance.draw();
    
    // Mostrar botão de limpar filtro
    $('#btnLimparFiltro').show();
}

// Função para limpar o filtro de vencimento
function limparFiltroVencimento() {
    if (!dataTableInstance || !filtroHojeAtivo) {
        return;
    }
    
    // Remover a função de filtro customizada
    if (funcaoFiltroHoje) {
        var index = $.fn.dataTable.ext.search.indexOf(funcaoFiltroHoje);
        if (index !== -1) {
            $.fn.dataTable.ext.search.splice(index, 1);
        }
        funcaoFiltroHoje = null;
    }
    
    // Marcar filtro como inativo
    filtroHojeAtivo = false;
    
    // Redesenhar a tabela sem o filtro
    dataTableInstance.draw();
    
    // Ocultar botão de limpar filtro
    $('#btnLimparFiltro').hide();
}

// Inicializar DataTables com filtros por coluna
$(document).ready(function() {
    // Aguardar um pouco para garantir que o script do base.html já executou (se houver)
    setTimeout(function() {
        // Destruir instância existente se houver (do base.html)
        if ($.fn.DataTable.isDataTable('#datatable')) {
            $('#datatable').DataTable().destroy();
        }
        
        // Reinicializar a tabela para garantir que está limpa
        dataTableInstance = $('#datatable').DataTable({
            language: {
                "lengthMenu": "_MENU_ Registros por página",
                "zeroRecords": "Nenhum registro encontrado",
                "info": "Total de registros: _TOTAL_",
                "infoEmpty": "Nenhum registro disponível",
                "infoFiltered": "(filtrado de _MAX_ registros)",
                "search": "Buscar:",
                "paginate": {
                    "first": "Primeira",
                    "last": "Última",
                    "next": "Próxima",
                    "previous": "Anterior"
                }
            },
            orderCellsTop: true,
            initComplete: function () {
                // Aplicar os filtros
                this.api().columns().every(function () {
                    var column = this;
                    var footer = $(column.footer());
                    
                    // Pular a última coluna (Ações)
                    if (footer.find('input').length === 0) {
                        return;
                    }
                    
                    // Aplicar filtro quando o usuário digitar
                    footer.find('input').on('keyup change', function () {
                        if (column.search() !== this.value) {
                            column.search(this.value).draw();
                        }
                    });
                });
            }
        });
        
        // Funcionalidade do checkbox "Selecionar todos"
        $('#selectAll').on('click', function() {
            const isChecked = $(this).prop('checked');
            $('.conta-checkbox').prop('checked', isChecked);
        });
        
        // Atualizar o checkbox "Selecionar todos" quando checkboxes individuais mudarem
        $(document).on('change', '.conta-checkbox', function() {
            const totalCheckboxes = $('.conta-checkbox').length;
            const checkedCheckboxes = $('.conta-checkbox:checked').length;
            $('#selectAll').prop('checked', totalCheckboxes === checkedCheckboxes);
        });
    }, 100);
});
</script>
{% endblock %}
