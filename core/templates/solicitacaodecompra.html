{% extends 'base.html' %}

{% block title %}Compras{% endblock %}

{% block content %}
    <div class="content" id="content">
      <h3 class="mt-4">Cadastro de Solicitação</h3>
        <form method="POST" id="form-solicitacao">
        {% csrf_token %}

        <!-- Campos do cabeçalho -->

        <div class="row">
                {% for field in form %}
                <div class="col-md-4 mb-2 form-floating">
                    {{ field }}
                    <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                </div>
                {% endfor %}
        </div>

        <hr>

        <!-- Botão para abrir modal -->
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#itemModal">
            <i class="bi bi-plus-circle"></i> Adicionar Item
        </button>

        <br><br>

        <!-- Tabela de itens -->
            <div class="tab-content table-responsive" id="myTabContent">
                <div class="tab-pane fade show active" id="home-tab-pane" role="tabpanel" aria-labelledby="home-tab" tabindex="0">
                    <table id="tabela-itens" class="table table-striped table-bordered">
                    <thead>
                    <tr>
                        <th>Item</th>
                        <th>Quantidade</th>
                        <th>Valor Unitário</th>
                        <th>Total</th>
                        <th>Ações</th>
                    </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>

        <!-- Campo escondido para enviar os itens em JSON -->
        <input type="hidden" name="itens_json" id="itens_json">

        <button type="submit" class="btn btn-success"><i class="bi bi-floppy"></i> Salvar Solicitação</button>
        </form>

<!-- Modal de adicionar item -->
<div class="modal fade" id="itemModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Adicionar Item</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label>Item</label>
          <select id="item" class="form-control">
            {% for i in itens %}
              <option value="{{ i.id }}">{{ i.descricao }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="mb-3">
          <label>Quantidade</label>
          <input type="number" id="quantidade" class="form-control">
        </div>
        <div class="mb-3">
          <label>Valor Unitário</label>
          <input type="number" step="0.01" id="valor_unitario" class="form-control">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="btn-add-item">Adicionar</button>
      </div>
    </div>
  </div>
</div>

<script>
// Funções relacionadas a itens de solicitação de compra
let itens = [];

document.addEventListener("DOMContentLoaded", function() {
    const btnAddItem = document.getElementById("btn-add-item");
    if (btnAddItem) {
        btnAddItem.addEventListener("click", function() {
            let itemSelect = document.getElementById("item");
            let quantidade = parseFloat(document.getElementById("quantidade").value) || 0;
            let valorUnitario = parseFloat(document.getElementById("valor_unitario").value) || 0;
            
            if (!itemSelect || !itemSelect.value) {
                alert('Por favor, selecione um item.');
                return;
            }
            
            if (quantidade <= 0) {
                alert('Por favor, informe uma quantidade válida.');
                return;
            }
            
            if (valorUnitario <= 0) {
                alert('Por favor, informe um valor unitário válido.');
                return;
            }
            
            let total = quantidade * valorUnitario;
            
            let obj = {
                id: itemSelect.value,
                nome: itemSelect.options[itemSelect.selectedIndex].text,
                quantidade: quantidade,
                valor_unitario: valorUnitario,
                total: total
            };
            
            itens.push(obj);
            atualizarTabela();
            atualizarValorTotal();
            
            // Limpar campos do modal
            document.getElementById("item").value = "";
            document.getElementById("quantidade").value = "";
            document.getElementById("valor_unitario").value = "";
            
            // Fechar modal
            var modal = bootstrap.Modal.getInstance(document.getElementById('itemModal'));
            if (modal) {
                modal.hide();
            }
        });
    }
    
    // Atualizar valor total quando o formulário for submetido
    const formSolicitacao = document.getElementById("form-solicitacao");
    if (formSolicitacao) {
        formSolicitacao.addEventListener("submit", function(e) {
            if (itens.length === 0) {
                alert('Por favor, adicione pelo menos um item à solicitação.');
                e.preventDefault();
                return false;
            }
            
            // Garantir que o valor total está atualizado antes de enviar
            atualizarValorTotal();
        });
    }
    
    // Inicializar valor total como 0,00
    atualizarValorTotal();
});

function atualizarTabela() {
    let tbody = document.querySelector("#tabela-itens tbody");
    if (tbody) {
        tbody.innerHTML = "";
        itens.forEach((i, index) => {
            tbody.innerHTML += `
                <tr>
                    <td>${i.nome}</td>
                    <td>${i.quantidade}</td>
                    <td>R$ ${i.valor_unitario.toFixed(2).replace('.', ',')}</td>
                    <td>R$ ${i.total.toFixed(2).replace('.', ',')}</td>
                    <td><button type="button" class="btn btn-danger btn-sm" onclick="removerItem(${index})"><i class="bi bi-trash"></i></button></td>
                </tr>
            `;
        });
    }
    
    const itensJson = document.getElementById("itens_json");
    if (itensJson) {
        itensJson.value = JSON.stringify(itens);
    }
}

function atualizarValorTotal() {
    const valorTotalElement = document.getElementById("id_valor_total");
    if (valorTotalElement) {
        let total = itens.reduce((acc, i) => acc + i.total, 0);
        // Formatar como moeda brasileira (com vírgula)
        let valorFormatado = total.toFixed(2).replace('.', ',');
        valorTotalElement.value = valorFormatado;
        
        // Aplicar máscara se disponível (jQuery mask)
        if (typeof $ !== 'undefined' && $.fn.mask) {
            $(valorTotalElement).unmask();
            $(valorTotalElement).mask('000.000.000,00', { reverse: true });
        }
    }
}

function removerItem(index) {
    if (index >= 0 && index < itens.length) {
        itens.splice(index, 1);
        atualizarTabela();
        atualizarValorTotal();
    }
}
</script>
{% endblock %}