{% extends 'base.html' %}

{% block title %}Devolução{% endblock %}

{% block actionMenu %}
{% endblock %}

{% block content %}
<div class="content">
  <h3>Devolução - Locação {{ locacao.codigo }}</h3>

  {% if editando_devolucao %}
    <div class="alert alert-info">
      <i class="bi bi-info-circle"></i>
      <strong>Editando devolução existente</strong> - Os novos itens serão adicionados à devolução atual.
    </div>
  {% else %}
    <div class="alert alert-success">
      <i class="bi bi-plus-circle"></i>
      <strong>Nova devolução</strong> - Criando uma nova devolução para esta locação.
    </div>
  {% endif %}

  <!-- Informações dos itens locados -->
  <div class="row mb-4">
    {% for item in itens_locacao %}
      <div class="col-md-4 mb-3">
        <div class="card">
          <div class="card-body">
            <h6 class="card-title">{{ item.produto.descricao }}</h6>
            <p class="card-text">
              <strong>Quantidade Locada:</strong> {{ item.quantidade }}<br>
              <strong>Saldo a Devolver:</strong> {{ item.saldo_disponivel_devolucao }}
            </p>
          </div>
        </div>
      </div>
    {% endfor %}
  </div>

  <hr>

  <!-- Formulário de devolução -->
  <form method="POST" id="form-devolucao" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="row">
      {% for field in form %}
        <div class="col-md-4 mb-2 form-floating">
          {{ field }}
          <label for="{{ field.id_for_label }}">{{ field.label }}</label>
        </div>
      {% endfor %}
    </div>

    <hr>

    <!-- Botões para modal e limpar sessão -->
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#itemModal">
      <i class="bi bi-plus-circle"></i> Adicionar Item para Devolução
    </button>
    <button type="button" class="btn btn-warning text-white" onclick="limparSessao()">
      <i class="bi bi-trash"></i> Limpar Sessão
    </button>

    <br><br>

    <!-- Tabela de itens -->
    <div class="table-responsive">
      <table id="tabela-itens" class="table table-striped table-bordered">
        <thead>
          <tr>
            <th>Produto</th>
            <th>Qtd Devolver</th>
            <th>Estado</th>
            <th>Data Devolução</th>
            <th>Custo Adicional</th>
            <th>Observações</th>
            <th>Códigos Estoque</th>
            <th>Foto</th>
            <th>Gerar Notificação</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Campo escondido para JSON dos itens -->
    <input type="hidden" name="itens_json" id="itens_json">

    <button type="submit" class="btn btn-success">
      <i class="bi bi-floppy"></i> Confirmar Devolução
    </button>
  </form>
</div>

<!-- Modal de adicionar item -->
<div class="modal fade" id="itemModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Adicionar Item</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="mb-3">
          <label>Item</label>
          <select id="item" class="form-control" onchange="atualizarMaxQtd(); carregarItensEstoque()">
            {% for i in itens_locacao %}
              <option value="{{ i.id }}" data-produto="{{ i.produto.descricao }}" data-produto-id="{{ i.produto.codigo }}" data-qtd="{{ i.quantidade }}" data-saldo="{{ i.saldo_disponivel_devolucao }}" data-ressarcimento="{{ i.produto.ressarcimento }}">
                {{ i.produto.descricao }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="mb-3" id="div-codigos-estoque" style="display: none;">
          <label>Código do Item de Estoque (obrigatório)</label>
          <div id="codigos_estoque_container" class="border rounded p-2" style="max-height: 150px; overflow-y: auto;"></div>
          <small class="form-text text-muted">Selecione apenas um item de estoque.</small>
        </div>

        <div class="mb-3" id="div-foto-item" style="display: none;">
          <label>Foto do Item (obrigatório)</label>
          <input type="file" id="foto_item" class="form-control" accept="image/*" capture="environment" required>
          <small class="form-text text-muted">Faça upload de uma foto do item para documentar o estado.</small>
        </div>

        <div class="mb-3">
          <label>Quantidade</label>
          <input type="number" id="quantidade" class="form-control" min="1" value="1" oninput="validarQuantidade(this); atualizarCustoPorQuantidade()">
        </div>

        <div class="mb-3">
          <label>Estado</label>
          <select id="estado" class="form-control" onchange="toggleCustoAdicional(); toggleCodigosEstoque()">
            <option value="bom">Bom</option>
            <option value="danificado">Danificado</option>
            <option value="inutilizado">Inutilizado</option>
          </select>
        </div>

        <div class="mb-3">
          <label>Custo Adicional R$ <small class="text-muted">(calculado automaticamente por quantidade)</small></label>
          <input type="text" id="custo_adicional" name="custo" class="form-control" oninput="formatarValor(this)" onkeypress="return apenasNumeros(event)" disabled>
        </div>

        <div class="mb-3">
          <label>Data de Devolução</label>
          <input type="date" id="data_devolucao" class="form-control" value="{{ 'now'|date:'Y-m-d' }}">
        </div>

        <div class="mb-3">
          <label>Observações</label>
          <textarea id="observacoes" class="form-control"></textarea>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="btn-add-item">Adicionar</button>
      </div>

    </div>
  </div>
</div>

<script>
  let itens_dev = [];

  // Adicionar item à lista
  document.getElementById("btn-add-item").addEventListener("click", function() {
    const select = document.getElementById("item");
    const itemId = select.value;
    const produto = select.options[select.selectedIndex].dataset.produto;
    const qtdLocada = select.options[select.selectedIndex].dataset.qtd;
    const saldo = select.options[select.selectedIndex].dataset.saldo;
    const quantidade = document.getElementById("quantidade").value;
    const estado = document.getElementById("estado").value;
    const observacoes = document.getElementById("observacoes").value;
    const custoAdicional = document.getElementById("custo_adicional").value;
    const fotoItem = document.getElementById("foto_item").files[0];
    const dataDevolucao = document.getElementById("data_devolucao").value;

    // Pega o código de estoque selecionado (apenas se o estado não for "bom")
    let codigosEstoque = [];
    if (estado !== 'bom') {
      const radioSelecionado = document.querySelector('#codigos_estoque_container input[type="radio"]:checked');
      if (radioSelecionado) codigosEstoque = [radioSelecionado.value];
    }

    // Valida quantidade
    if (quantidade <= 0) {
      alert("Quantidade inválida!");
      return;
    }

    // Valida seleção de código de estoque
    if (estado !== 'bom' && codigosEstoque.length === 0) {
      alert("Por favor, selecione um código de estoque para este item.");
      return;
    }

    // Valida foto
    if (estado !== 'bom' && !fotoItem) {
      alert("Por favor, faça upload de uma foto do item para documentar o estado.");
      return;
    }

    // Verifica quantidade já adicionada na sessão
    let quantidadeJaAdicionada = 0;
    itens_dev.forEach(item => {
      if (item.item_locacao_id == itemId && !item.item_id) {
        quantidadeJaAdicionada += parseInt(item.quantidade);
      }
    });

    const saldoInicial = parseInt(select.options[select.selectedIndex].dataset.saldo);
    const saldoDisponivel = saldoInicial - quantidadeJaAdicionada;

    if (quantidade > saldoDisponivel) {
      alert(`A quantidade máxima permitida é ${saldoDisponivel} (saldo disponível para devolução)`);
      return;
    }

    // Converte custo para número
    let custoNumerico = 0;
    if (custoAdicional && custoAdicional !== '') {
      custoNumerico = parseFloat(custoAdicional.replace(',', '.'));
    }

    const item = {
      item_locacao_id: itemId,
      produto: produto,
      quantidade: quantidade,
      estado: estado,
      observacoes: observacoes,
      custo_adicional: custoNumerico,
      qtd_locada: qtdLocada,
      saldo: saldo,
      codigos_estoque: codigosEstoque,
      foto_item: fotoItem ? fotoItem.name : null,
      data_devolucao: dataDevolucao
    };

    itens_dev.push(item);
    atualizarTabelaDevolucao();
    document.getElementById("itens_json").value = JSON.stringify(itens_dev);

    // Adiciona arquivo de foto oculto ao formulário
    if (fotoItem) {
      const hiddenInput = document.createElement('input');
      hiddenInput.type = 'file';
      hiddenInput.name = `foto_item_${item.item_locacao_id}`;
      hiddenInput.style.display = 'none';
      const dataTransfer = new DataTransfer();
      dataTransfer.items.add(fotoItem);
      hiddenInput.files = dataTransfer.files;
      document.getElementById('form-devolucao').appendChild(hiddenInput);
    }

    // Fecha modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('itemModal'));
    modal.hide();
  });

  // Atualiza tabela
  function atualizarTabelaDevolucao() {
    const tbody = document.querySelector("#tabela-itens tbody");
    tbody.innerHTML = "";

    itens_dev.forEach((i, index) => {
      let custoFormatado = '-';
      if (i.custo_adicional && i.custo_adicional > 0) {
        custoFormatado = `R$ ${parseFloat(i.custo_adicional).toFixed(2).replace('.', ',')}`;
      }

      // Saldo disponível
      const itemId = i.item_locacao_id;
      const saldoInicial = parseInt(document.querySelector(`option[value="${itemId}"]`).dataset.saldo);
      let quantidadeJaAdicionada = 0;
      itens_dev.forEach(item => {
        if (item.item_locacao_id == itemId && !item.item_id) {
          quantidadeJaAdicionada += parseInt(item.quantidade);
        }
      });
      const saldoDisponivel = saldoInicial - quantidadeJaAdicionada;

      // Códigos de estoque
      let codigosFormatados = '-';
      if (i.estado !== 'bom' && i.codigos_estoque && i.codigos_estoque.length > 0) {
        const codigosInfo = i.codigos_estoque.map(codigoId => {
          const itemEstoque = itensEstoqueDisponiveis.find(item => item.id === codigoId);
          return itemEstoque ? itemEstoque.codigo : codigoId;
        });
        codigosFormatados = codigosInfo.join(', ');
      }

      // Foto
      let fotoFormatada = '-';
      if (i.foto_item) {
        const itemConfirmado = !!(i.item_id || i.id);
        const botaoClasse = itemConfirmado ? 'btn-primary' : 'btn-secondary';
        const botaoTexto = itemConfirmado ? 'Ver Foto' : 'Ver Foto (Bloqueado)';
        fotoFormatada = `<button type="button" class="btn btn-sm ${botaoClasse} text-white" onclick="abrirFoto('${i.foto_item}', ${itemConfirmado})">${botaoTexto}</button>`;
      }

      const dataFormatada = i.data_devolucao || '-';
      const itemConfirmado = !!(i.item_id || i.id);
      const linhaClasse = itemConfirmado ? '' : 'table-warning';

      // Botão de gerar notificação
      let botaoNotificacao = '-';
      if (itemConfirmado) {
        botaoNotificacao = `<button type="button" class="btn btn-info btn-sm text-white" onclick="gerarNotificacao(${index})" title="Gerar notificação para este item">
          <i class="bi bi-bell"></i> Gerar Notificação
        </button>`;
      } else {
        botaoNotificacao = `<button type="button" class="btn btn-secondary btn-sm text-white" disabled title="Confirme a devolução primeiro para gerar notificação">
          <i class="bi bi-bell-slash"></i> Pendente
        </button>`;
      }

      tbody.innerHTML += `
        <tr class="${linhaClasse}">
          <td>${i.produto} ${itemConfirmado ? '<span class="badge bg-success">Confirmado</span>' : '<span class="badge bg-warning">Pendente</span>'}</td>
          <td>${i.quantidade}</td>
          <td>${i.estado}</td>
          <td>${dataFormatada}</td>
          <td>${custoFormatado}</td>
          <td>${i.observacoes}</td>
          <td>${codigosFormatados}</td>
          <td>${fotoFormatada}</td>
          <td>${botaoNotificacao}</td>
          <td><button type="button" class="btn btn-danger btn-sm" onclick="removerItem(${index})">Remover</button></td>
        </tr>
      `;
    });
  }

  // Remove item da lista
  function removerItem(index) {
    itens_dev.splice(index, 1);
    atualizarTabelaDevolucao();
    document.getElementById("itens_json").value = JSON.stringify(itens_dev);
    atualizarMaxQtd();
  }

function atualizarMaxQtd() {
    const select = document.getElementById("item");
    const itemId = select.value;
    const saldoInicial = parseInt(select.options[select.selectedIndex].dataset.saldo);
    const estado = document.getElementById("estado").value;

    let quantidadeJaAdicionada = 0;
    // LINHA CORRIGIDA:
    itens_dev.forEach(item => { // <-- USAR "itens_dev" AQUI
      if (item.item_locacao_id == itemId && !item.item_id) quantidadeJaAdicionada += parseInt(item.quantidade);
    });

    const saldoDisponivel = saldoInicial - quantidadeJaAdicionada;
    const quantidadeInput = document.getElementById("quantidade");

    if (estado !== 'bom') {
      quantidadeInput.value = 1;
      quantidadeInput.disabled = true;
    } else {
      quantidadeInput.value = 1;
      quantidadeInput.disabled = false;
    }

    atualizarCustoPorQuantidade();
}

  // Habilita/desabilita custo adicional
  function toggleCustoAdicional() {
    const estado = document.getElementById("estado").value;
    const custoAdicional = document.getElementById("custo_adicional");
    if (estado === "bom") {
      custoAdicional.disabled = true;
      custoAdicional.value = "";
    } else {
      custoAdicional.disabled = false;
      atualizarCustoPorQuantidade();
    }
  }

  // Atualiza custo baseado na quantidade
  function atualizarCustoPorQuantidade() {
    const estado = document.getElementById("estado").value;
    const custoAdicional = document.getElementById("custo_adicional");
    const itemSelect = document.getElementById("item");
    const quantidade = parseInt(document.getElementById("quantidade").value);

    if (estado !== "bom" && quantidade && quantidade > 0) {
      const ressarcimento = itemSelect.options[itemSelect.selectedIndex].dataset.ressarcimento;
      if (ressarcimento && ressarcimento !== '') {
        let valorNumerico = parseFloat(ressarcimento.replace(',', '.'));
        let custoTotal = valorNumerico * quantidade;
        custoAdicional.value = custoTotal.toFixed(2).replace('.', ',');
      }
    }
  }

  // Permite apenas números
  function apenasNumeros(event) {
    const char = String.fromCharCode(event.which);
    if (!/[0-9]/.test(char)) {
      event.preventDefault();
      return false;
    }
    return true;
  }

  // Formata valor monetário
  function formatarValor(input) {
    let valor = input.value.replace(/\D/g, '');
    if (valor === '') { input.value = ''; return; }
    let numero = parseInt(valor);
    let valorFormatado = (numero / 100).toFixed(2);
    input.value = valorFormatado.replace('.', ',');
  }

  function validarQuantidade(input) {
    const estado = document.getElementById("estado").value;
    if (estado !== 'bom') { input.value = 1; return; }

    const itemSelect = document.getElementById("item");
    const itemId = itemSelect.value;
    const saldoInicial = parseInt(itemSelect.options[itemSelect.selectedIndex].dataset.saldo);

    let quantidadeJaAdicionada = 0;
    itens_dev.forEach(item => {
      if (item.item_locacao_id == itemId && !item.item_id) quantidadeJaAdicionada += parseInt(item.quantidade);
    });

    const saldoDisponivel = saldoInicial - quantidadeJaAdicionada;
    const quantidadeDigitada = parseInt(input.value);

    if (quantidadeDigitada > saldoDisponivel) {
      input.value = saldoDisponivel;
      alert(`A quantidade máxima permitida é ${saldoDisponivel} (saldo disponível para devolução)`);
    }
  }

  // Itens de estoque disponíveis
  const itensEstoqueDisponiveis = JSON.parse('{{ itens_estoque_locados|escapejs }}');
  const itensDevolucaoExistentes = JSON.parse('{{ itens_devolucao_existentes|escapejs }}');

  // Carrega itens existentes
  if (itensDevolucaoExistentes && itensDevolucaoExistentes.length > 0) {
    itens_dev = itensDevolucaoExistentes;
    atualizarTabelaDevolucao();
    document.getElementById("itens_json").value = JSON.stringify(itens_dev);
  }

  // Carrega itens de estoque
  function carregarItensEstoque() {
    const itemSelect = document.getElementById('item');
    const codigosContainer = document.getElementById('codigos_estoque_container');
    const produtoId = itemSelect.options[itemSelect.selectedIndex].dataset.produtoId;

    codigosContainer.innerHTML = '';

    const itensFiltrados = itensEstoqueDisponiveis.filter(item => item.produto_id === produtoId);

    itensFiltrados.forEach(item => {
      const div = document.createElement('div');
      div.className = 'form-check';

      const radio = document.createElement('input');
      radio.type = 'radio';
      radio.className = 'form-check-input';
      radio.name = 'codigo_estoque';
      radio.id = `codigo_${item.id}`;
      radio.value = item.id;

      const label = document.createElement('label');
      label.className = 'form-check-label';
      label.htmlFor = `codigo_${item.id}`;
      label.textContent = `${item.codigo}${item.numero_serie ? ' - Série: ' + item.numero_serie : ''}`;

      div.appendChild(radio);
      div.appendChild(label);
      codigosContainer.appendChild(div);
    });
  }

  // Mostrar/ocultar campo de códigos baseado no estado
  function toggleCodigosEstoque() {
    const estadoSelect = document.getElementById('estado');
    const divCodigos = document.getElementById('div-codigos-estoque');
    const divFoto = document.getElementById('div-foto-item');
    const quantidadeInput = document.getElementById('quantidade');

    if (estadoSelect.value !== 'bom') {
      divCodigos.style.display = 'block';
      divFoto.style.display = 'block';
      carregarItensEstoque();
      quantidadeInput.value = 1;
      quantidadeInput.disabled = true;
      document.getElementById('foto_item').required = true;
    } else {
      divCodigos.style.display = 'none';
      divFoto.style.display = 'none';
      const radios = document.querySelectorAll('#codigos_estoque_container input[type="radio"]');
      radios.forEach(radio => radio.checked = false);
      document.getElementById('foto_item').value = '';
      document.getElementById('foto_item').required = false;
      quantidadeInput.disabled = false;
    }
  }

  // Abrir foto
  function abrirFoto(caminhoFoto, itemConfirmado = false) {
    if (!itemConfirmado) {
      alert('Para verificar a foto, confirme a devolução primeiro.');
      return;
    }
    if (caminhoFoto) {
      const urlFoto = `/media/${caminhoFoto}`;
      window.open(urlFoto, '_blank');
    } else {
      alert('Nenhuma foto disponível para este item.');
    }
  }

  // Limpar sessão
  function limparSessao() {
    if (confirm('Tem certeza que deseja limpar todos os itens da sessão atual?')) {
      itens_dev = [];
      atualizarTabelaDevolucao();
      document.getElementById("itens_json").value = JSON.stringify(itens_dev);
      console.log('Sessão limpa!');
    }
  }

  // Limpar formulário do modal
  function limparFormularioModal() {
    document.getElementById('item').selectedIndex = 0;
    document.getElementById('quantidade').value = 1;
    document.getElementById('estado').selectedIndex = 0;
    document.getElementById('custo_adicional').value = '';
    document.getElementById('data_devolucao').value = new Date().toISOString().split('T')[0];
    document.getElementById('observacoes').value = '';
    document.getElementById('foto_item').value = '';
    const radios = document.querySelectorAll('#codigos_estoque_container input[type="radio"]');
    radios.forEach(radio => radio.checked = false);
    document.getElementById('div-codigos-estoque').style.display = 'none';
    document.getElementById('div-foto-item').style.display = 'none';
    document.getElementById('quantidade').disabled = false;
    document.getElementById('foto_item').required = false;
  }

  // Gerar notificação para um item específico
  function gerarNotificacao(index) {
    const item = itens_dev[index];
    if (!item) {
      alert('Item não encontrado!');
      return;
    }

    // Verifica se o item está confirmado
    if (!item.item_id && !item.id) {
      alert('Este item ainda não foi confirmado. Confirme a devolução primeiro para gerar a notificação.');
      return;
    }

    // Dados do item para a notificação
    const dadosNotificacao = {
      produto: item.produto,
      quantidade: item.quantidade,
      estado: item.estado,
      dataDevolucao: item.data_devolucao || new Date().toISOString().split('T')[0],
      observacoes: item.observacoes || '',
      custoAdicional: item.custo_adicional || 0,
      codigosEstoque: item.codigos_estoque || [],
      fotoItem: item.foto_item || null
    };

    // Aqui você pode implementar a lógica de geração da notificação
    // Por exemplo, abrir um modal, enviar para o servidor, etc.
    console.log('Gerando notificação para o item:', dadosNotificacao);
    
    // Exemplo: Abrir modal de notificação
    alert(`Notificação gerada para:\n\n` +
          `Produto: ${dadosNotificacao.produto}\n` +
          `Quantidade: ${dadosNotificacao.quantidade}\n` +
          `Estado: ${dadosNotificacao.estado}\n` +
          `Data: ${dadosNotificacao.dataDevolucao}\n` +
          `Observações: ${dadosNotificacao.observacoes || 'Nenhuma'}\n` +
          `Custo Adicional: R$ ${dadosNotificacao.custoAdicional.toFixed(2).replace('.', ',')}`);
  }

  // Inicializar funcionalidades da página
  function inicializarDevolucao() {
    const modal = document.getElementById('itemModal');
    if (modal) {
      modal.addEventListener('shown.bs.modal', function() {
        atualizarMaxQtd();
        carregarItensEstoque();
      });

      modal.addEventListener('hidden.bs.modal', function() {
        limparFormularioModal();
      });
    }
  }

  // Inicializar após DOM carregado
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', inicializarDevolucao);
  } else {
    inicializarDevolucao();
  }
</script>
{% endblock %}